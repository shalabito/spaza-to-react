---
// src/components/CatalogScene.astro
---

<div id="catalog-container"></div>

<script>
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
  import { RoomEnvironment } from 'three/examples/jsm/environments/RoomEnvironment.js';
  
  // Scene setup
  const scene = new THREE.Scene();
  const renderer = new THREE.WebGLRenderer({ 
    antialias: true,
    alpha: true 
  });
  
  let camera;
  let mixer;
  const clock = new THREE.Clock();
  
  // Setup renderer
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setClearColor(0x000000);
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1;
  
  const container = document.getElementById('catalog-container');
  container.appendChild(renderer.domElement);
  
  // Setup Room Environment (same as Three.js editor)
  const pmremGenerator = new THREE.PMREMGenerator(renderer);
  pmremGenerator.compileEquirectangularShader();
  
  const roomEnvironment = new RoomEnvironment();
  const roomEnvironmentTexture = pmremGenerator.fromScene(roomEnvironment).texture;
  
  // Apply environment to scene
  scene.environment = roomEnvironmentTexture;
  scene.background = roomEnvironmentTexture; // Optional: if you want the environment as background
  
  console.log('Room environment setup complete');
  
  // Load your scene
  const loader = new GLTFLoader();
  loader.load(
    '/models/spaza-catalog.glb',
    // Success callback
    (gltf) => {
      console.log('Model loaded successfully:', gltf);
      
      const model = gltf.scene;
      scene.add(model);
      
      // Find and use the camera from the GLB file
      let foundCamera = null;
      gltf.scene.traverse((child) => {
        if (child.isCamera) {
          foundCamera = child;
          console.log('Found camera in scene:', child);
        }
      });
      
      if (!foundCamera && gltf.cameras && gltf.cameras.length > 0) {
        foundCamera = gltf.cameras[0];
      }
      
      if (foundCamera) {
        camera = foundCamera;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        console.log('Using camera from GLB file');
      } else {
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);
        console.warn('No camera found in GLB, using fallback camera');
      }
      
      // Setup animations
      if (gltf.animations && gltf.animations.length > 0) {
        mixer = new THREE.AnimationMixer(model);
        
        gltf.animations.forEach((clip) => {
          const action = mixer.clipAction(clip);
          action.play();
        });
        
        console.log('Started', gltf.animations.length, 'animations');
      }
      
      console.log('Scene setup complete with room environment lighting');
    },
    // Progress callback
    (progress) => {
      console.log('Loading progress:', (progress.loaded / progress.total * 100) + '%');
    },
    // Error callback
    (error) => {
      console.error('Error loading model:', error);
    }
  );
  
  // Handle window resize
  function onWindowResize() {
    if (camera) {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
    }
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
  window.addEventListener('resize', onWindowResize);
  
  // Animation loop
  function animate() {
    requestAnimationFrame(animate);
    
    const deltaTime = clock.getDelta();
    if (mixer) {
      mixer.update(deltaTime);
    }
    
    if (camera) {
      renderer.render(scene, camera);
    }
  }
  animate();
  
  // Cleanup
  window.addEventListener('beforeunload', () => {
    if (mixer) {
      mixer.stopAllAction();
    }
    pmremGenerator.dispose();
    renderer.dispose();
    window.removeEventListener('resize', onWindowResize);
  });
</script>

<style>
  #catalog-container {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }
  
  #catalog-container canvas {
    display: block;
  }
</style>